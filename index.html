function doPost(e) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();

  const username = e.parameter.username;
  const password = e.parameter.password || "";
  const score = Number(e.parameter.score);
  const level = Number(e.parameter.level);

  if (!username) {
    return output("Missing username");
  }

  const dataRange = sheet.getDataRange();
  const data = dataRange.getValues();
  let rowFound = -1;

  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === username) {
      rowFound = i + 1;
      break;
    }
  }

  /* ===============================
     âœ… LOGIN MODE (MULTI-DEVICE)
     =============================== */
  if (
    rowFound !== -1 &&
    password &&
    !e.parameter.hasOwnProperty("score") &&
    !e.parameter.hasOwnProperty("level")
  ) {
    const storedPassword = sheet.getRange(rowFound, 2).getValue();

    if (storedPassword === password) {
      return output(
        "Login successful|" +
        sheet.getRange(rowFound, 3).getValue() + "|" + // Total Score
        sheet.getRange(rowFound, 4).getValue()         // Current Level
      );
    } else {
      return output("Invalid password");
    }
  }

  /* =====================================================
     âœ… ADDED: UNIVERSAL UPDATE MODE (FOR ALL USERS)
     ===================================================== */
  if (
    rowFound !== -1 &&
    e.parameter.hasOwnProperty("score") &&
    e.parameter.hasOwnProperty("level") &&
    !isNaN(score) &&
    !isNaN(level)
  ) {
    sheet.getRange(rowFound, 3).setValue(score); // Total Score
    sheet.getRange(rowFound, 4).setValue(level); // Current Level
    sheet.getRange(rowFound, 5).setValue(new Date());
    return output("Score and level updated (universal)");
  }

  /* ===============================
     SIGN UP MODE
     =============================== */
  if (password && score === 0) {
    if (rowFound !== -1) {
      return output("User already exists");
    }

    sheet.appendRow([
      username,
      password,
      0,          // Total Score
      0,          // Current Level
      new Date()
    ]);

    // ðŸ”¤ SORT ALL USERS ALPHABETICALLY (BY USERNAME)
    const lastRow = sheet.getLastRow();
    if (lastRow > 2) {
      sheet
        .getRange(2, 1, lastRow - 1, sheet.getLastColumn())
        .sort({ column: 1, ascending: true });
    }

    return output("Signup successful");
  }

  /* ===============================
     UPDATE SCORE + LEVEL MODE
     (original â€“ left untouched)
     =============================== */
  if (rowFound !== -1 && !isNaN(score) && !isNaN(level)) {
    sheet.getRange(rowFound, 3).setValue(score); // Total Score
    sheet.getRange(rowFound, 4).setValue(level); // Current Level
    sheet.getRange(rowFound, 5).setValue(new Date());
    return output("Score and level updated");
  }

  return output("Invalid request");
}

function doGet() {
  return output("Game Score API is running");
}

function output(message) {
  return ContentService
    .createTextOutput(message)
    .setMimeType(ContentService.MimeType.TEXT);
}
